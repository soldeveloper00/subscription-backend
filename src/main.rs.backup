use actix_web::{web, App, HttpServer, Responder, get, HttpResponse};

// Import only the modules that exist
use routes::{signals, wallet_simple, safe_integration, subscription, minimal_blockchain};

mod routes;

// Simple health endpoint for early testing
#[get("/_health")]
async fn health() -> impl Responder {
    "OK"
}

// Root endpoint with API documentation
#[get("/")]
async fn index() -> impl Responder {
    HttpResponse::Ok()
        .content_type("text/html; charset=utf-8")
        .body(r#"
            <!DOCTYPE html>
            <html>
            <head>
                <title>Trading Signals Backend API</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                    h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
                    h3 { color: #2c3e50; margin-top: 25px; }
                    .endpoint { 
                        background: #f8f9fa; 
                        padding: 12px 15px; 
                        margin: 8px 0; 
                        border-radius: 5px; 
                        border-left: 4px solid #3498db;
                    }
                    .method { 
                        display: inline-block; 
                        width: 70px; 
                        padding: 3px 8px; 
                        margin-right: 10px; 
                        border-radius: 3px; 
                        text-align: center; 
                        font-weight: bold; 
                        font-size: 0.9em; 
                    }
                    .get { background: #d4edda; color: #155724; }
                    .post { background: #d1ecf1; color: #0c5460; }
                    a { color: #2980b9; text-decoration: none; }
                    a:hover { text-decoration: underline; }
                    code { 
                        background: #f1f1f1; 
                        padding: 2px 6px; 
                        border-radius: 3px; 
                        font-family: monospace; 
                    }
                    .container { max-width: 800px; margin: 0 auto; }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>üöÄ Trading Signals Backend API</h1>
                    <p>Your backend is successfully deployed on Railway! üéâ</p>
                    
                    <h3>üìä Available Endpoints:</h3>
                    <div class="endpoint">
                        <span class="method get">GET</span> 
                        <a href="/_health">/_health</a> - Health check endpoint
                    </div>
                    <div class="endpoint">
                        <span class="method get">GET</span> 
                        <a href="/health">/health</a> - Full health check with coin info
                    </div>
                    <div class="endpoint">
                        <span class="method get">GET</span> 
                        <a href="/wallet/info">/wallet/info</a> - Wallet information
                    </div>
                    <div class="endpoint">
                        <span class="method get">GET</span> 
                        <a href="/wallet/test-connection">/wallet/test-connection</a> - Test Solana connection
                    </div>
                    <div class="endpoint">
                        <span class="method post">POST</span> 
                        /integration/set-condition - Set price condition
                    </div>
                    <div class="endpoint">
                        <span class="method get">GET</span> 
                        <a href="/integration/example">/integration/example</a> - Check condition example
                    </div>
                    <div class="endpoint">
                        <span class="method get">GET</span> 
                        <a href="/prices">/prices</a> - Live prices for BTC/ETH/SOL/PAXG
                    </div>
                    <div class="endpoint">
                        <span class="method get">GET</span> 
                        <a href="/signals">/signals</a> - Trading signals
                    </div>
                    <div class="endpoint">
                        <span class="method post">POST</span> 
                        /tradingview-webhook - Receive TradingView alerts
                    </div>
                    <div class="endpoint">
                        <span class="method get">GET</span> 
                        <a href="/tradingview-alerts">/tradingview-alerts</a> - Recent TradingView alerts
                    </div>
                    <div class="endpoint">
                        <span class="method get">GET</span> 
                        <a href="/alerts/{symbol}">/alerts/{symbol}</a> - Alerts for specific symbol
                    </div>
                    <div class="endpoint">
                        <span class="method get">GET</span> 
                        <a href="/cache-stats">/cache-stats</a> - Cache statistics
                    </div>
                    <div class="endpoint">
                        <span class="method post">POST</span> 
                        /clear-alerts - Clear all alerts
                    </div>
                    <div class="endpoint">
                        <span class="method post">POST</span> 
                        /clear-cache - Clear price cache
                    </div>
                    <div class="endpoint">
                        <span class="method post">POST</span> 
                        /subscribe - Subscribe service
                    </div>
                    <div class="endpoint">
                        <span class="method get">GET</span> 
                        <a href="/status">/status</a> - Service status
                    </div>
                    <div class="endpoint">
                        <span class="method get">GET</span> 
                        <a href="/blockchain/status">/blockchain/status</a> - Blockchain status
                    </div>
                    <div class="endpoint">
                        <span class="method get">GET</span> 
                        <a href="/blockchain/test-integration">/blockchain/test-integration</a> - Test blockchain integration
                    </div>
                    
                    <h3>üîß Testing Instructions:</h3>
                    <p>Use <code>curl</code>, Postman, or Insomnia to test the endpoints:</p>
                    <pre><code>curl https://your-app-name.up.railway.app/health
curl https://your-app-name.up.railway.app/prices</code></pre>
                    
                    <p><strong>‚úÖ Supported Coins: BTC, ETH, SOL, PAXG</strong></p>
                </div>
            </body>
            </html>
        "#)
}

#[actix_web::main]
async fn main() -> std::io::Result<()> {
    // CRITICAL: Catch and log panics before they silently crash
    std::panic::set_hook(Box::new(|panic_info| {
        let location = panic_info.location().map(|loc| loc.to_string()).unwrap_or_else(|| "unknown location".to_string());
        let payload = panic_info.payload();
        let message = if let Some(s) = payload.downcast_ref::<&str>() {
            *s
        } else if let Some(s) = payload.downcast_ref::<String>() {
            s.as_str()
        } else {
            "Unknown panic"
        };
        
        eprintln!("üî• APPLICATION PANIC DETECTED");
        eprintln!("üìå Message: {}", message);
        eprintln!("üìç Location: {}", location);
        eprintln!("üîç Backtrace (if enabled):");
        
        // Force backtrace if RUST_BACKTRACE is set
        if std::env::var("RUST_BACKTRACE").is_ok() {
            eprintln!("{:?}", std::backtrace::Backtrace::force_capture());
        }
        
        std::process::exit(1);
    }));

    // Enable backtrace for debugging
    std::env::set_var("RUST_BACKTRACE", "1");
    
    // Debug: Print environment info
    println!("üîß DEBUG: Starting application initialization");
    println!("üîß DEBUG: PORT env var: {:?}", std::env::var("PORT"));
    println!("üîß DEBUG: Current dir: {:?}", std::env::current_dir());
    
    // Use PORT from environment or default to 8080
    let port: u16 = std::env::var("PORT")
        .unwrap_or_else(|_| {
            println!("‚ö†Ô∏è  DEBUG: PORT not set, defaulting to 8080");
            "8080".to_string()
        })
        .parse()
        .expect("‚ùå PORT must be a number");

    println!("üöÄ Starting Trading Signals Backend on 0.0.0.0:{}", port);
    println!("üìä Supported Coins: BTC, ETH, SOL, PAXG");
    println!("üåê Endpoints:");
    println!("   GET  /");
    println!("   GET  /_health (debug endpoint)");
    println!("   GET  /health (full health check)");
    println!("   GET  /prices");
    println!("   GET  /signals");
    println!("   POST /tradingview-webhook");
    println!("   GET  /tradingview-alerts");
    println!("   GET  /alerts/{{symbol}}");
    println!("   GET  /cache-stats");
    println!("   POST /clear-alerts");
    println!("   POST /clear-cache");
    println!("   GET  /wallet/info");
    println!("   GET  /wallet/test-connection");
    println!("   POST /integration/set-condition");
    println!("   GET  /integration/example");
    println!("   POST /subscribe");
    println!("   GET  /status");
    println!("   GET  /blockchain/status");
    println!("   GET  /blockchain/test-integration");

    HttpServer::new(|| {
        println!("üîß DEBUG: Creating App instance (this runs multiple times)");
        
        App::new()
            // Root endpoint with documentation
            .service(index)
            // Debug health endpoint
            .service(health)
            
            // Signals endpoints (using your simplified signals.rs)
            .route("/health", web::get().to(signals::health_check))
            .route("/prices", web::get().to(signals::get_prices))
            .route("/signals", web::get().to(signals::get_signals))
            .route("/tradingview-webhook", web::post().to(signals::tradingview_webhook))
            .route("/tradingview-alerts", web::get().to(signals::get_tradingview_alerts))
            .route("/alerts/{symbol}", web::get().to(signals::get_symbol_alerts))
            .route("/cache-stats", web::get().to(signals::get_cache_stats))
            .route("/clear-alerts", web::post().to(signals::clear_alerts))
            .route("/clear-cache", web::post().to(signals::clear_cache))
            
            // Wallet endpoints
            .route("/wallet/info", web::get().to(wallet_simple::wallet_info))
            .route("/wallet/test-connection", web::get().to(wallet_simple::test_solana_connection))

            // Integration endpoints
            .route("/integration/set-condition", web::post().to(safe_integration::set_price_condition))
            .route("/integration/example", web::get().to(safe_integration::check_condition_example))

            // Subscription endpoints
            .route("/subscribe", web::post().to(subscription::subscribe))
            .route("/status", web::get().to(subscription::status))

            // Blockchain endpoints
            .route("/blockchain/status", web::get().to(minimal_blockchain::blockchain_status))
            .route("/blockchain/test-integration", web::get().to(minimal_blockchain::test_integration))
    })
    .bind(("0.0.0.0", port))
    .map_err(|e| {
        eprintln!("‚ùå FAILED TO BIND TO PORT {}: {}", port, e);
        e
    })?
    .run()
    .await
}